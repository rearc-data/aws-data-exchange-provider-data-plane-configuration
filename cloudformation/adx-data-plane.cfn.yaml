Description: Create S3 bucket and cross-account role for ADX data plane with minimal permissions.
Parameters:
  AssetBucketName:
    Type: String
    Default: rearc-data-provider
    Description: Bucket containing assets and referenced in the manifest.
  CreateAssetBucket:
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Description: Defines if the asset bucket should be provisioned.
  ControlPlaneAccount:
    Type: String
    Description: ID of the control plane account to connect to.
  ExternalId:
    Type: String
    Description: External ID for connecting to the control plane - provided during onboarding.
Conditions:
  ShouldCreateAssetBucket:
    Fn::Equals:
      - Ref: CreateAssetBucket
      - "true"
  CDKMetadataAvailable:
    Fn::Or:
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - af-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-northeast-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-northeast-2
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-southeast-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-southeast-2
          - Fn::Equals:
              - Ref: AWS::Region
              - ca-central-1
          - Fn::Equals:
              - Ref: AWS::Region
              - cn-north-1
          - Fn::Equals:
              - Ref: AWS::Region
              - cn-northwest-1
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-central-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-north-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-2
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-3
          - Fn::Equals:
              - Ref: AWS::Region
              - me-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - sa-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-east-2
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - us-west-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-west-2
Resources:
  AssetBucket1D025086:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Ref: AssetBucketName
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: ADXDataPlaneStack/AssetBucket/Resource
    Condition: ShouldCreateAssetBucket
  CrossAccountRoleFACE29D1:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId:
                  Ref: ExternalId
            Effect: Allow
            Principal:
              AWS:
                Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":iam::"
                    - Ref: ControlPlaneAccount
                    - :root
        Version: "2012-10-17"
      Path: /
    Metadata:
      aws:cdk:path: ADXDataPlaneStack/CrossAccountRole/Resource
  CrossAccountRoleDefaultPolicy212A317F:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - dataexchange:GetDataSet
              - dataexchange:ListDataSets
              - dataexchange:UpdateRevision
              - dataexchange:ListJobs
              - dataexchange:GetJob
              - dataexchange:CreateAsset
              - dataexchange:GetRevision
              - dataexchange:CreateJob
              - dataexchange:CreateRevision
              - dataexchange:UpdateDataSet
              - dataexchange:UpdateAsset
              - dataexchange:StartJob
              - dataexchange:ListDataSetRevisions
            Effect: Allow
            Resource: "*"
          - Action:
              - aws-marketplace:ListChangeSets
              - aws-marketplace:DescribeChangeSet
              - aws-marketplace:StartChangeSet
              - aws-marketplace:CancelChangeSet
              - aws-marketplace:ListEntities
              - aws-marketplace:DescribeEntity
              - aws-marketplace:ListTasks
              - aws-marketplace:DescribeTask
              - aws-marketplace:UpdateTask
              - aws-marketplace:CompleteTask
            Effect: Allow
            Resource: "*"
          - Action:
              - s3:GetObject
              - s3:ListBucket
            Condition:
              ForAnyValue:StringEquals:
                aws:CalledVia: dataexchange.amazonaws.com
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: AssetBucketName
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: AssetBucketName
                    - /*
          - Action:
              - s3:GetObject
              - s3:ListBucket
              - s3:PutObject
              - s3:PutObjectAcl
            Condition:
              ForAnyValue:StringEquals:
                aws:CalledVia: dataexchange.amazonaws.com
            Effect: Allow
            Resource: arn:aws:s3:::*aws-data-exchange*
        Version: "2012-10-17"
      PolicyName: CrossAccountRoleDefaultPolicy212A317F
      Roles:
        - Ref: CrossAccountRoleFACE29D1
    Metadata:
      aws:cdk:path: ADXDataPlaneStack/CrossAccountRole/DefaultPolicy/Resource
  CDKMetadata:
    Type: AWS::CDK::Metadata
    Properties:
      Analytics: v2:deflate64:H4sIAAAAAAAAEzWOSwrDMAxEz9K9oyQECt2V5gIhPYFRVFA+FthySzG+e+OEruYNgzTTQtvcoLnc7SdUOC11QvEE6akWF9O/3GC93UjJF9OLm1hZnNkpqI+oZqQg0SOV/M/ZlHcpdJAeERfSEp6UDdsN0ijreVF0kJXxe7QdlHM2TiaCOdTv9grdPnAOzJWPTnkjGE/9Aa8X7DW9AAAA
    Metadata:
      aws:cdk:path: ADXDataPlaneStack/CDKMetadata/Default
    Condition: CDKMetadataAvailable

